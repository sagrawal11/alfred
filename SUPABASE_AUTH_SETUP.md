# Supabase Auth: What You Have vs What to Set Up

This doc describes what is **already implemented in the Alfred codebase** and what you **must configure in the Supabase Dashboard** for auth (including password reset) to work.

---

## What You Have Right Now (in the codebase)

### Backend (Flask + Supabase client)

- **Registration:** `AuthManager.register_with_email_password()` creates a user in Supabase Auth and a linked row in the custom `users` table (`auth_user_id`).
- **Login:** `AuthManager.login_with_email_password()` signs in via Supabase Auth and loads the custom user by `auth_user_id`; session stored in Flask (user_id, email, auth tokens).
- **Password reset request:** `AuthManager.request_password_reset(email)` calls Supabase `reset_password_for_email()` with a **redirect URL** so the email link sends users to your app’s reset page (`BASE_URL/dashboard/reset-password`).
- **Password reset (client-side):** The reset page loads Supabase JS, reads the recovery tokens from the URL hash (Supabase redirects with `#access_token=...&type=recovery`), sets the session, and calls `supabase.auth.updateUser({ password })` on submit.
- **Forgot-password API:** `POST /dashboard/forgot-password` accepts JSON `{ "email": "..." }` (used by the Settings modal) and form POST (used by the forgot-password page).
- **Phone OTP (optional):** `send_phone_otp` / `verify_phone_otp` use Supabase Auth; used if you enable phone verification.

### Frontend

- **Landing:** Login / Sign up modals; “Forgot Password?” links to `/dashboard/forgot-password`.
- **Forgot password page:** Form to enter email; submits to `POST /dashboard/forgot-password`; always shows a generic success message.
- **Reset password page:** Rendered at `/dashboard/reset-password`. If the URL has a recovery hash (from the email link), the page uses Supabase JS to set the session and show the “new password” form; on submit it calls `updateUser({ password })` and redirects to the landing page with `?reset=success`.
- **Settings:** “Send reset link” in the Security section calls `POST /dashboard/forgot-password` with JSON and shows the response message.
- **Landing after reset:** If the URL has `?reset=success`, the login modal opens with a “Password reset successfully” message.

### Database (migration already provided)

- **`supabase_schema_auth_migration.sql`** adds `auth_user_id` to `users`, indexes, and helpers. You must run this in the Supabase SQL Editor if you haven’t already.

### Environment variables (used by the app)

- **`SUPABASE_URL`** – Project URL (e.g. `https://xxxx.supabase.co`).
- **`SUPABASE_KEY`** – Used for server-side auth (sign_up, sign_in, reset_password_for_email). For the reset page, the same key is passed to the browser; it **must** be the **anon** (public) key, not the service role key.
- **`BASE_URL`** – Full URL of your app (e.g. `https://yourapp.com` or `http://localhost:5001`). Used for the password reset redirect and Stripe.

---

## What You Must Set Up in Supabase

### 1. Project URL and keys

- In **Project Settings → API**: copy **Project URL** and **anon public** key into `SUPABASE_URL` and `SUPABASE_KEY`.
- Do **not** use the **service_role** key in the browser or for the reset page; use it only for server-only admin operations if needed.

### 2. Email provider (required for password reset and signup emails)

- Go to **Authentication → Providers → Email**.
- Ensure **Email** is enabled.
- Under **Auth → Email Templates** (or **Authentication → Email Templates**), you can customize:
  - **Confirm signup** – Sent when a user signs up (if “Confirm email” is on).
  - **Magic Link** – Optional.
  - **Change Email Address** – Optional.
  - **Reset Password** – This is the email sent when a user requests a password reset. The link in the email is generated by Supabase and will redirect to the URL you pass as `redirect_to` (your app’s `/dashboard/reset-password`).

Supabase sends these emails for you; you do **not** need your own SMTP for basic reset/signup unless you want to use a custom SMTP server ( **Project Settings → Auth → SMTP** ).

### 3. Redirect URLs (required for password reset)

- Go to **Authentication → URL Configuration** (or **Auth → URL Configuration**).
- Set **Site URL** to your app’s base URL (e.g. `https://yourapp.com` or `http://localhost:5001`).
- In **Redirect URLs**, add:
  - `http://localhost:5001/dashboard/reset-password` (development)
  - `https://your-production-domain.com/dashboard/reset-password` (production)

The password reset email link will redirect users to one of these URLs with the recovery tokens in the hash. If the URL is not in the list, Supabase will not redirect there.

### 4. Confirm email (optional)

- Under **Authentication → Providers → Email**, you can enable or disable **Confirm email**.
- If enabled, users must click the confirmation link before they can log in (Supabase sends the email).
- If disabled, users can log in immediately after signup.

### 5. Phone provider (optional)

- Only needed if you use phone OTP (e.g. `send_phone_otp` / `verify_phone_otp`).
- **Authentication → Providers → Phone**: enable and connect a Twilio (or other) SMS provider as per Supabase docs.

### 6. JWT / session (optional tuning)

- **Project Settings → API → JWT Settings**: you can change JWT expiry if needed.
- Defaults are usually fine for the current Flask + Supabase JS flow.

---

## Checklist summary

| Item | In codebase? | You configure in Supabase |
|------|----------------|----------------------------|
| Registration (email/password) | Yes | Email provider enabled; optional: Confirm email, SMTP |
| Login (email/password) | Yes | — |
| Forgot-password (send email) | Yes | Email provider; Reset Password template |
| Reset-password (set new password) | Yes (client-side on reset page) | **Redirect URLs** must include `/dashboard/reset-password`; **Site URL** set |
| Custom `users` table + `auth_user_id` | Yes | Run `supabase_schema_auth_migration.sql` |
| Phone OTP | Yes (optional) | Phone provider + Twilio (or other) |
| Session in Flask | Yes | — |

---

## Quick test

1. Set **Site URL** and **Redirect URLs** in Supabase as above.
2. Set `BASE_URL`, `SUPABASE_URL`, and `SUPABASE_KEY` (anon) in your env.
3. Open your app → **Forgot Password** (or Settings → Send reset link), enter an email that exists in Supabase Auth.
4. Check the inbox (or Supabase Auth logs); click the reset link.
5. You should land on `/dashboard/reset-password` with the form; set a new password and submit.
6. You should be redirected to the landing page with “Password reset successfully” and can log in with the new password.

If the link doesn’t open your app or the reset page doesn’t get the tokens, double-check **Redirect URLs** and **Site URL** in Supabase.
