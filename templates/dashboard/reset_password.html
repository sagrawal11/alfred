<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Butler:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard/style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='Alfred.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='Alfred.png') }}">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <h1>Reset Password</h1>
            <div id="reset-no-link" class="reset-no-link" style="display: none;">
                <p class="info-message">Use the link from your password reset email to set a new password.</p>
                <p><a href="{{ url_for('dashboard_forgot_password') }}">Send a new reset link</a></p>
            </div>
            <div id="reset-form-wrap">
                {% if error %}
                    <div class="error-message">{{ error }}</div>
                {% endif %}
                <form id="reset-form" method="POST" action="{{ url_for('dashboard_reset_password', token=token) if token else '#' }}">
                    {% if token %}
                    <input type="hidden" name="token" value="{{ token }}">
                    {% endif %}
                    <div class="form-group">
                        <label for="password">New Password:</label>
                        <input type="password" id="password" name="password" required minlength="8" autocomplete="new-password">
                        <small>Must be at least 8 characters</small>
                    </div>
                    <div class="form-group">
                        <label for="password_confirm">Confirm New Password:</label>
                        <input type="password" id="password_confirm" name="password_confirm" required autocomplete="new-password">
                    </div>
                    <button type="submit" class="btn-primary" id="reset-submit">Reset Password</button>
                    <div id="reset-status" class="setting-status" style="margin-top: 0.5rem;"></div>
                </form>
            </div>
            <div class="login-footer">
                <p><a href="{{ url_for('dashboard_login') }}">Back to Login</a></p>
            </div>
        </div>
    </div>
    {% include 'includes/site_footer.html' %}
    <script>
        (function () {
            const supabaseUrl = {{ (supabase_url or '')|tojson }};
            const supabaseAnonKey = {{ (supabase_anon_key or '')|tojson }};
            const hasToken = {{ (token and token != '')|tojson }};
            const formWrap = document.getElementById('reset-form-wrap');
            const noLink = document.getElementById('reset-no-link');
            const form = document.getElementById('reset-form');
            const status = document.getElementById('reset-status');

            function parseHash() {
                const hash = window.location.hash.slice(1);
                if (!hash) return {};
                const params = {};
                hash.split('&').forEach(function (part) {
                    const eq = part.indexOf('=');
                    if (eq >= 0) {
                        params[decodeURIComponent(part.slice(0, eq))] = decodeURIComponent(part.slice(eq + 1));
                    }
                });
                return params;
            }

            if (hasToken) {
                formWrap.style.display = 'block';
                noLink.style.display = 'none';
                return;
            }

            const hashParams = parseHash();
            const type = hashParams.type || '';
            const accessToken = hashParams.access_token;
            const refreshToken = hashParams.refresh_token;

            if (type === 'recovery' && accessToken && supabaseUrl && supabaseAnonKey) {
                formWrap.style.display = 'block';
                noLink.style.display = 'none';
                form.setAttribute('action', '#');
                form.removeAttribute('method');

                const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                supabase.auth.setSession({ access_token: accessToken, refresh_token: refreshToken }).then(function () {
                    form.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const password = document.getElementById('password').value;
                        const passwordConfirm = document.getElementById('password_confirm').value;
                        if (!password || password.length < 8) {
                            if (status) status.textContent = 'Password must be at least 8 characters.';
                            return;
                        }
                        if (password !== passwordConfirm) {
                            if (status) status.textContent = 'Passwords do not match.';
                            return;
                        }
                        if (status) status.textContent = 'Updating...';
                        const submitBtn = document.getElementById('reset-submit');
                        if (submitBtn) submitBtn.disabled = true;
                        try {
                            const { error } = await supabase.auth.updateUser({ password: password });
                            if (error) throw error;
                            window.location.href = {{ url_for('landing_page')|tojson }} + '?reset=success';
                        } catch (err) {
                            if (status) status.textContent = err.message || 'Password update failed.';
                            if (submitBtn) submitBtn.disabled = false;
                        }
                    });
                }).catch(function (err) {
                    if (status) status.textContent = 'Invalid or expired link. Request a new reset link.';
                    if (noLink) noLink.style.display = 'block';
                    formWrap.style.display = 'none';
                });
                return;
            }

            formWrap.style.display = 'none';
            noLink.style.display = 'block';
        })();
    </script>
</body>
</html>
