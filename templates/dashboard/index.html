<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Calendar View</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Butler:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard/style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='Alfred.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='Alfred.png') }}">
</head>
<body>
    <div class="dashboard-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, msg in messages %}
                    <div class="flash flash-{{ category }}">{{ msg }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <header class="dashboard-header">
            <h1>Activity Dashboard</h1>
            <div class="header-actions">
                <a href="{{ url_for('dashboard_integrations') }}" class="btn-secondary">üîó Integrations</a>
                <a href="{{ url_for('dashboard_settings') }}" class="btn-secondary">‚öôÔ∏è Settings</a>
                <a href="{{ url_for('dashboard_chat') }}" class="btn-secondary">üí¨ Chat Test</a>
                <a href="{{ url_for('dashboard_test') }}" class="btn-secondary">üß™ Test Jobs</a>
                <a href="{{ url_for('dashboard_logout') }}" class="btn-logout">Logout</a>
            </div>
        </header>
        
        <div class="dashboard-content">
            <div class="calendar-section">
                <div class="calendar-controls">
                    <button id="prev-month" class="btn-nav">‚Üê Previous</button>
                    <h2 id="current-month"></h2>
                    <button id="next-month" class="btn-nav">Next ‚Üí</button>
                </div>
                <div id="calendar-grid" class="calendar-grid"></div>
            </div>
            
            <div class="stats-section">
                <div id="stats-panel" class="stats-panel">
                    <p class="placeholder-text">Click on a date to view stats</p>
                </div>
                
                <div class="trends-section">
                    <h3>Trends</h3>
                    <div class="trend-buttons">
                        <button class="btn-trend" data-days="7">7 Days</button>
                        <button class="btn-trend" data-days="30">30 Days</button>
                        <button class="btn-trend" data-days="90">90 Days</button>
                    </div>
                    <p class="trends-hint">Click a date on the calendar, then select a time period to view trends ending on that date</p>
                    <div id="trends-display" class="trends-display">
                        <p class="placeholder-text">Select a time period to view trends</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentDate = new Date();
        let selectedDate = null;
        let selectedTrendDays = null;
        let selectedTrendEndDate = null;
        
        // Month names
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        // Get today's date as YYYY-MM-DD (local time, no timezone issues)
        function getTodayString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Parse date string YYYY-MM-DD to Date object (local time)
        function parseLocalDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }
        
        // Check if date is in the future
        function isFutureDate(dateStr) {
            const todayStr = getTodayString();
            return dateStr > todayStr;
        }
        
        // Initialize calendar
        function initCalendar() {
            renderCalendar();
            setupEventListeners();
        }
        
        function setupEventListeners() {
            document.getElementById('prev-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
            
            document.getElementById('next-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });
            
            // Trend buttons - now require clicking a date first (or use today)
            document.querySelectorAll('.btn-trend').forEach(btn => {
                btn.addEventListener('click', () => {
                    const days = parseInt(btn.dataset.days);
                    // Use selected date or today as end date
                    const endDate = selectedDate || getTodayString();
                    if (isFutureDate(endDate)) {
                        alert('Cannot select future dates');
                        return;
                    }
                    selectTrendRange(days, endDate);
                });
            });
        }
        
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update month header
            document.getElementById('current-month').textContent = 
                `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Create calendar grid
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            // Add day headers
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Add empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day empty';
                grid.appendChild(empty);
            }
            
            // Add days of month
            const todayStr = getTodayString();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                dayElement.dataset.date = dateStr;
                
                // Disable future dates
                if (isFutureDate(dateStr)) {
                    dayElement.classList.add('future');
                    dayElement.style.opacity = '0.4';
                    dayElement.style.cursor = 'not-allowed';
                } else {
                    dayElement.addEventListener('click', () => {
                        selectDate(dateStr);
                    });
                }
                
                // Highlight today with outline
                if (dateStr === todayStr) {
                    dayElement.classList.add('today');
                }
                
                grid.appendChild(dayElement);
            }
            
            // Apply range highlighting if a trend range is selected
            if (selectedTrendDays && selectedTrendEndDate) {
                highlightTrendRange(selectedTrendDays, selectedTrendEndDate);
            }
        }
        
        function highlightTrendRange(days, endDateStr) {
            const endDate = parseLocalDate(endDateStr);
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - (days - 1));
            
            // Normalize dates to compare just the date part (ignore time)
            const startDateStr = startDate.getFullYear() + '-' + 
                                String(startDate.getMonth() + 1).padStart(2, '0') + '-' + 
                                String(startDate.getDate()).padStart(2, '0');
            const endDateStrNormalized = endDateStr;
            
            document.querySelectorAll('.calendar-day').forEach(dayEl => {
                const dateStr = dayEl.dataset.date;
                if (!dateStr || dayEl.classList.contains('empty')) return;
                
                const date = parseLocalDate(dateStr);
                if (date >= startDate && date <= endDate && !dayEl.classList.contains('future')) {
                    dayEl.classList.add('in-range');
                    
                    // Add special styling for first and last dates
                    if (dateStr === startDateStr) {
                        dayEl.classList.add('range-start');
                    }
                    if (dateStr === endDateStrNormalized) {
                        dayEl.classList.add('range-end');
                    }
                }
            });
        }
        
        function selectTrendRange(days, endDate) {
            selectedTrendDays = days;
            selectedTrendEndDate = endDate;
            
            // Update active button
            document.querySelectorAll('.btn-trend').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.days) === days) {
                    btn.classList.add('active');
                }
            });
            
            // Re-render calendar to show range highlighting
            renderCalendar();
            
            // Load trends
            loadTrends(days, endDate);
        }
        
        function selectDate(date) {
            if (isFutureDate(date)) {
                return; // Prevent selecting future dates
            }
            
            selectedDate = date;
            
            // Clear trend selection
            selectedTrendDays = null;
            selectedTrendEndDate = null;
            document.querySelectorAll('.btn-trend').forEach(btn => btn.classList.remove('active'));
            
            // Update selected state
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
                day.classList.remove('in-range');
            });
            const selectedElement = document.querySelector(`[data-date="${date}"]`);
            if (selectedElement) {
                selectedElement.classList.add('selected');
            }
            
            // Load stats for this date
            loadDateStats(date);
            
            // Clear trends display
            document.getElementById('trends-display').innerHTML = '<p class="placeholder-text">Select a time period to view trends</p>';
        }
        
        async function loadDateStats(date) {
            const panel = document.getElementById('stats-panel');
            panel.innerHTML = '<p>Loading...</p>';
            
            try {
                const response = await fetch(`/dashboard/api/date/${date}`);
                if (!response.ok) {
                    throw new Error('Failed to load stats');
                }
                
                const data = await response.json();
                displayDateStats(date, data);
            } catch (error) {
                panel.innerHTML = `<p class="error">Error loading stats: ${error.message}</p>`;
            }
        }
        
        function displayDateStats(date, data) {
            const panel = document.getElementById('stats-panel');
            // Parse date as local date to avoid timezone issues
            const dateObj = parseLocalDate(date);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let html = `<h3>${formattedDate}</h3>`;
            
            // Food logs
            html += '<div class="stats-section-item"><h4>Food</h4>';
            if (data.food_logs && data.food_logs.length > 0) {
                html += '<ul>';
                data.food_logs.forEach(log => {
                    html += `<li>${log.food_name || 'Unknown'}: ${log.calories || 0} cal`;
                    if (log.protein || log.carbs || log.fat) {
                        html += ` (${log.protein || 0}g P, ${log.carbs || 0}g C, ${log.fat || 0}g F)`;
                    }
                    html += '</li>';
                });
                html += '</ul>';
                if (data.food_totals) {
                    html += `<p class="totals">Total: ${Math.round(data.food_totals.calories || 0)} cal, `;
                    html += `${Math.round(data.food_totals.protein || 0)}g protein, `;
                    html += `${Math.round(data.food_totals.carbs || 0)}g carbs, `;
                    html += `${Math.round(data.food_totals.fat || 0)}g fat</p>`;
                }
            } else {
                html += '<p>No food logs</p>';
            }
            html += '</div>';
            
            // Water logs
            html += '<div class="stats-section-item"><h4>Water</h4>';
            if (data.water_logs && data.water_logs.length > 0) {
                html += '<ul>';
                data.water_logs.forEach(log => {
                    const ml = log.amount_ml || 0;
                    const oz = log.amount_oz || 0;
                    html += `<li>${Math.round(ml)}ml (${oz.toFixed(1)}oz)</li>`;
                });
                html += '</ul>';
                html += `<p class="totals">Total: ${Math.round(data.water_total_ml || 0)}ml / ${Math.round(data.water_goal_ml || 4000)}ml goal</p>`;
                const progress = data.water_goal_ml > 0 ? (data.water_total_ml / data.water_goal_ml * 100) : 0;
                html += `<div class="progress-bar"><div class="progress-fill" style="width: ${Math.min(progress, 100)}%"></div></div>`;
            } else {
                html += '<p>No water logs</p>';
            }
            html += '</div>';
            
            // Gym logs
            html += '<div class="stats-section-item"><h4>Workouts</h4>';
            if (data.gym_logs && data.gym_logs.length > 0) {
                html += '<ul>';
                data.gym_logs.forEach(log => {
                    html += `<li>${log.exercise || 'Exercise'}`;
                    if (log.weight || log.reps || log.sets) {
                        html += `: `;
                        const parts = [];
                        if (log.weight) parts.push(`${log.weight}lbs`);
                        if (log.reps) parts.push(`${log.reps} reps`);
                        if (log.sets) parts.push(`${log.sets} sets`);
                        html += parts.join(', ');
                    }
                    if (log.notes) {
                        html += ` <span class="notes">(${log.notes})</span>`;
                    }
                    html += '</li>';
                });
                html += '</ul>';
            } else {
                html += '<p>No workouts</p>';
            }
            html += '</div>';
            
            // Todos
            html += '<div class="stats-section-item"><h4>Todos</h4>';
            if (data.todos && (data.todos.completed.length > 0 || data.todos.unfinished.length > 0)) {
                if (data.todos.unfinished.length > 0) {
                    html += '<p class="section-label">Unfinished:</p><ul>';
                    data.todos.unfinished.forEach(todo => {
                        html += `<li>${todo.content || 'Todo'}</li>`;
                    });
                    html += '</ul>';
                }
                if (data.todos.completed.length > 0) {
                    html += '<p class="section-label">Completed:</p><ul class="completed">';
                    data.todos.completed.forEach(todo => {
                        html += `<li>${todo.content || 'Todo'}</li>`;
                    });
                    html += '</ul>';
                }
            } else {
                html += '<p>No todos</p>';
            }
            html += '</div>';
            
            // Reminders
            html += '<div class="stats-section-item"><h4>Reminders</h4>';
            if (data.reminders && (data.reminders.completed.length > 0 || data.reminders.unfinished.length > 0)) {
                if (data.reminders.unfinished.length > 0) {
                    html += '<p class="section-label">Unfinished:</p><ul>';
                    data.reminders.unfinished.forEach(reminder => {
                        html += `<li>${reminder.content || 'Reminder'}`;
                        if (reminder.due_date) {
                            const dueDate = new Date(reminder.due_date);
                            html += ` <span class="due-date">(due: ${dueDate.toLocaleString()})</span>`;
                        }
                        html += '</li>';
                    });
                    html += '</ul>';
                }
                if (data.reminders.completed.length > 0) {
                    html += '<p class="section-label">Completed:</p><ul class="completed">';
                    data.reminders.completed.forEach(reminder => {
                        html += `<li>${reminder.content || 'Reminder'}</li>`;
                    });
                    html += '</ul>';
                }
            } else {
                html += '<p>No reminders</p>';
            }
            html += '</div>';
            
            // Assignments
            html += '<div class="stats-section-item"><h4>Assignments</h4>';
            if (data.assignments && (data.assignments.due_today.length > 0 || data.assignments.past_due.length > 0)) {
                if (data.assignments.past_due.length > 0) {
                    html += '<p class="section-label">Past Due:</p><ul>';
                    data.assignments.past_due.forEach(assignment => {
                        const dueDate = new Date(assignment.due_date);
                        html += `<li><strong>${assignment.class_name || 'Class'}</strong> - ${assignment.assignment_name || 'Assignment'}`;
                        html += ` <span class="due-date" style="color: #ff6b6b;">(due: ${dueDate.toLocaleDateString()})</span>`;
                        html += '</li>';
                    });
                    html += '</ul>';
                }
                if (data.assignments.due_today.length > 0) {
                    html += '<p class="section-label">Due Today:</p><ul>';
                    data.assignments.due_today.forEach(assignment => {
                        const dueDate = new Date(assignment.due_date);
                        html += `<li><strong>${assignment.class_name || 'Class'}</strong> - ${assignment.assignment_name || 'Assignment'}`;
                        html += ` <span class="due-date">(due: ${dueDate.toLocaleTimeString()})</span>`;
                        html += '</li>';
                    });
                    html += '</ul>';
                }
            } else {
                html += '<p>No assignments</p>';
            }
            html += '</div>';
            
            panel.innerHTML = html;
        }
        
        async function loadTrends(days, endDate) {
            const display = document.getElementById('trends-display');
            display.innerHTML = '<p>Loading...</p>';
            
            try {
                // Include end_date parameter if provided
                const url = endDate ? `/dashboard/api/trends/${days}?end_date=${endDate}` : `/dashboard/api/trends/${days}`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Failed to load trends');
                }
                
                const data = await response.json();
                displayTrends(data, days);
            } catch (error) {
                display.innerHTML = `<p class="error">Error loading trends: ${error.message}</p>`;
            }
        }
        
        function displayTrends(data, days) {
            const display = document.getElementById('trends-display');
            let html = `<h4>${days}-Day Summary</h4>`;
            html += `<p class="date-range">${data.date_range}</p>`;
            html += '<div class="trend-metrics">';
            html += `<div class="trend-metric"><span class="metric-label">Water (avg):</span> <span class="metric-value">${Math.round(data.water_avg_ml)}ml/day</span></div>`;
            html += `<div class="trend-metric"><span class="metric-label">Calories (avg):</span> <span class="metric-value">${Math.round(data.calories_avg)}/day</span></div>`;
            html += `<div class="trend-metric"><span class="metric-label">Gym days:</span> <span class="metric-value">${data.gym_days}</span></div>`;
            html += `<div class="trend-metric"><span class="metric-label">Todo completion:</span> <span class="metric-value">${data.todo_completion_rate.toFixed(1)}%</span></div>`;
            html += '</div>';
            
            display.innerHTML = html;
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initCalendar);
    </script>
</body>
</html>

