<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Calendar View</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Butler:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard/style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='Alfred.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='Alfred.png') }}">
</head>
<body>
    <div class="app-shell">
        <aside class="sidebar">
            <a class="sidebar-logo" href="{{ url_for('dashboard_index') }}">
                <img src="{{ url_for('static', filename='Alfred.png') }}" alt="Alfred" class="sidebar-logo-img">
                <span class="sidebar-logo-text">Alfred</span>
            </a>

            <nav class="sidebar-nav">
                <a class="sidebar-link {% if active_page == 'trends' %}active{% endif %}" href="{{ url_for('dashboard_trends') }}">Trends</a>
                <a class="sidebar-link {% if active_page == 'integrations' %}active{% endif %}" href="{{ url_for('dashboard_integrations') }}">Integrations</a>
                <a class="sidebar-link {% if active_page == 'preferences' %}active{% endif %}" href="{{ url_for('dashboard_preferences') }}">Preferences</a>
                <a class="sidebar-link {% if active_page == 'pricing' %}active{% endif %}" href="{{ url_for('dashboard_pricing') }}">Pricing</a>
                <a class="sidebar-link {% if active_page == 'chat' %}active{% endif %}" href="{{ url_for('dashboard_chat') }}">Chat Test</a>
                <a class="sidebar-link {% if active_page == 'test_jobs' %}active{% endif %}" href="{{ url_for('dashboard_test') }}">Test Jobs</a>
            </nav>

            <div class="sidebar-spacer"></div>

            <div class="sidebar-footer">
                <button class="profile-button" id="profile-button" type="button">
                    <div class="profile-name">{{ (user.name or user.email or 'Profile') }}</div>
                    <div class="profile-meta">Profile</div>
                </button>
                <div class="profile-menu" id="profile-menu">
                    <a href="{{ url_for('dashboard_settings') }}">Settings</a>
                    <a href="{{ url_for('dashboard_logout') }}">Log out</a>
                </div>
            </div>
        </aside>

        <main class="main-area">
            <div class="dashboard-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, msg in messages %}
                    <div class="flash flash-{{ category }}">{{ msg }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <header class="dashboard-header">
            <h1>Activity Dashboard</h1>
        </header>
        
        <div class="dashboard-content">
            <div class="calendar-section">
                <div class="calendar-controls">
                    <button id="prev-month" class="btn-nav">← Previous</button>
                    <h2 id="current-month"></h2>
                    <button id="next-month" class="btn-nav">Next →</button>
                </div>
                <div id="calendar-grid" class="calendar-grid"></div>
            </div>
            
            <div class="stats-section">
                <div id="stats-panel" class="stats-panel">
                    <p class="placeholder-text">Click on a date to view stats</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentDate = new Date();
        let selectedDate = null;
        
        // Month names
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        // Get today's date as YYYY-MM-DD (local time, no timezone issues)
        function getTodayString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Parse date string YYYY-MM-DD to Date object (local time)
        function parseLocalDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }
        
        // Check if date is in the future
        function isFutureDate(dateStr) {
            const todayStr = getTodayString();
            return dateStr > todayStr;
        }
        
        // Initialize calendar
        function initCalendar() {
            renderCalendar();
            setupEventListeners();
        }
        
        function setupEventListeners() {
            document.getElementById('prev-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
            
            document.getElementById('next-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });
        }
        
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update month header
            document.getElementById('current-month').textContent = 
                `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Create calendar grid
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            // Add day headers
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Add empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day empty';
                grid.appendChild(empty);
            }
            
            // Add days of month
            const todayStr = getTodayString();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                dayElement.dataset.date = dateStr;
                
                // Disable future dates
                if (isFutureDate(dateStr)) {
                    dayElement.classList.add('future');
                    dayElement.style.opacity = '0.4';
                    dayElement.style.cursor = 'not-allowed';
                } else {
                    dayElement.addEventListener('click', () => {
                        selectDate(dateStr);
                    });
                }
                
                // Highlight today with outline
                if (dateStr === todayStr) {
                    dayElement.classList.add('today');
                }
                
                grid.appendChild(dayElement);
            }
            
        }
        
        function selectDate(date) {
            if (isFutureDate(date)) {
                return; // Prevent selecting future dates
            }
            
            selectedDate = date;
            
            // Update selected state
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
                day.classList.remove('in-range');
            });
            const selectedElement = document.querySelector(`[data-date="${date}"]`);
            if (selectedElement) {
                selectedElement.classList.add('selected');
            }
            
            // Load stats for this date
            loadDateStats(date);
        }
        
        async function loadDateStats(date) {
            const panel = document.getElementById('stats-panel');
            panel.innerHTML = '<p>Loading...</p>';
            
            try {
                const response = await fetch(`/dashboard/api/date/${date}`);
                if (!response.ok) {
                    throw new Error('Failed to load stats');
                }
                
                const data = await response.json();
                displayDateStats(date, data);
            } catch (error) {
                panel.innerHTML = `<p class="error">Error loading stats: ${error.message}</p>`;
            }
        }
        
        function displayDateStats(date, data) {
            const panel = document.getElementById('stats-panel');
            // Parse date as local date to avoid timezone issues
            const dateObj = parseLocalDate(date);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let html = `<h3>${formattedDate}</h3>`;
            
            // Food logs
            html += '<div class="stats-section-item"><h4>Food</h4>';
            if (data.food_logs && data.food_logs.length > 0) {
                html += '<ul>';
                data.food_logs.forEach(log => {
                    html += `<li>${log.food_name || 'Unknown'}: ${log.calories || 0} cal`;
                    if (log.protein || log.carbs || log.fat) {
                        html += ` (${log.protein || 0}g P, ${log.carbs || 0}g C, ${log.fat || 0}g F)`;
                    }
                    html += '</li>';
                });
                html += '</ul>';
                if (data.food_totals) {
                    html += `<p class="totals">Total: ${Math.round(data.food_totals.calories || 0)} cal, `;
                    html += `${Math.round(data.food_totals.protein || 0)}g protein, `;
                    html += `${Math.round(data.food_totals.carbs || 0)}g carbs, `;
                    html += `${Math.round(data.food_totals.fat || 0)}g fat</p>`;
                }
            } else {
                html += '<p>No food logs</p>';
            }
            html += '</div>';
            
            // Water logs
            html += '<div class="stats-section-item"><h4>Water</h4>';
            if (data.water_logs && data.water_logs.length > 0) {
                html += '<ul>';
                data.water_logs.forEach(log => {
                    const ml = log.amount_ml || 0;
                    const oz = log.amount_oz || 0;
                    html += `<li>${Math.round(ml)}ml (${oz.toFixed(1)}oz)</li>`;
                });
                html += '</ul>';
                html += `<p class="totals">Total: ${Math.round(data.water_total_ml || 0)}ml / ${Math.round(data.water_goal_ml || 4000)}ml goal</p>`;
                const progress = data.water_goal_ml > 0 ? (data.water_total_ml / data.water_goal_ml * 100) : 0;
                html += `<div class="progress-bar"><div class="progress-fill" style="width: ${Math.min(progress, 100)}%"></div></div>`;
            } else {
                html += '<p>No water logs</p>';
            }
            html += '</div>';
            
            // Gym logs
            html += '<div class="stats-section-item"><h4>Workouts</h4>';
            if (data.gym_logs && data.gym_logs.length > 0) {
                html += '<ul>';
                data.gym_logs.forEach(log => {
                    html += `<li>${log.exercise || 'Exercise'}`;
                    if (log.weight || log.reps || log.sets) {
                        html += `: `;
                        const parts = [];
                        if (log.weight) parts.push(`${log.weight}lbs`);
                        if (log.reps) parts.push(`${log.reps} reps`);
                        if (log.sets) parts.push(`${log.sets} sets`);
                        html += parts.join(', ');
                    }
                    if (log.notes) {
                        html += ` <span class="notes">(${log.notes})</span>`;
                    }
                    html += '</li>';
                });
                html += '</ul>';
            } else {
                html += '<p>No workouts</p>';
            }
            html += '</div>';
            
            // Todos
            html += '<div class="stats-section-item"><h4>Todos</h4>';
            if (data.todos && (data.todos.completed.length > 0 || data.todos.unfinished.length > 0)) {
                if (data.todos.unfinished.length > 0) {
                    html += '<p class="section-label">Unfinished:</p><ul>';
                    data.todos.unfinished.forEach(todo => {
                        html += `<li>${todo.content || 'Todo'}</li>`;
                    });
                    html += '</ul>';
                }
                if (data.todos.completed.length > 0) {
                    html += '<p class="section-label">Completed:</p><ul class="completed">';
                    data.todos.completed.forEach(todo => {
                        html += `<li>${todo.content || 'Todo'}</li>`;
                    });
                    html += '</ul>';
                }
            } else {
                html += '<p>No todos</p>';
            }
            html += '</div>';
            
            // Reminders
            html += '<div class="stats-section-item"><h4>Reminders</h4>';
            if (data.reminders && (data.reminders.completed.length > 0 || data.reminders.unfinished.length > 0)) {
                if (data.reminders.unfinished.length > 0) {
                    html += '<p class="section-label">Unfinished:</p><ul>';
                    data.reminders.unfinished.forEach(reminder => {
                        html += `<li>${reminder.content || 'Reminder'}`;
                        if (reminder.due_date) {
                            const dueDate = new Date(reminder.due_date);
                            html += ` <span class="due-date">(due: ${dueDate.toLocaleString()})</span>`;
                        }
                        html += '</li>';
                    });
                    html += '</ul>';
                }
                if (data.reminders.completed.length > 0) {
                    html += '<p class="section-label">Completed:</p><ul class="completed">';
                    data.reminders.completed.forEach(reminder => {
                        html += `<li>${reminder.content || 'Reminder'}</li>`;
                    });
                    html += '</ul>';
                }
            } else {
                html += '<p>No reminders</p>';
            }
            html += '</div>';
            
            // Assignments
            html += '<div class="stats-section-item"><h4>Assignments</h4>';
            if (data.assignments && (data.assignments.due_today.length > 0 || data.assignments.past_due.length > 0)) {
                if (data.assignments.past_due.length > 0) {
                    html += '<p class="section-label">Past Due:</p><ul>';
                    data.assignments.past_due.forEach(assignment => {
                        const dueDate = new Date(assignment.due_date);
                        html += `<li><strong>${assignment.class_name || 'Class'}</strong> - ${assignment.assignment_name || 'Assignment'}`;
                        html += ` <span class="due-date" style="color: #ff6b6b;">(due: ${dueDate.toLocaleDateString()})</span>`;
                        html += '</li>';
                    });
                    html += '</ul>';
                }
                if (data.assignments.due_today.length > 0) {
                    html += '<p class="section-label">Due Today:</p><ul>';
                    data.assignments.due_today.forEach(assignment => {
                        const dueDate = new Date(assignment.due_date);
                        html += `<li><strong>${assignment.class_name || 'Class'}</strong> - ${assignment.assignment_name || 'Assignment'}`;
                        html += ` <span class="due-date">(due: ${dueDate.toLocaleTimeString()})</span>`;
                        html += '</li>';
                    });
                    html += '</ul>';
                }
            } else {
                html += '<p>No assignments</p>';
            }
            html += '</div>';
            
            panel.innerHTML = html;
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initCalendar);

        // Profile dropdown
        (function () {
            const btn = document.getElementById('profile-button');
            const menu = document.getElementById('profile-menu');
            if (!btn || !menu) return;
            btn.addEventListener('click', () => {
                menu.classList.toggle('open');
            });
            window.addEventListener('click', (e) => {
                if (!menu.classList.contains('open')) return;
                if (btn.contains(e.target) || menu.contains(e.target)) return;
                menu.classList.remove('open');
            });
        })();
    </script>
</main>
</div>
</body>
</html>

